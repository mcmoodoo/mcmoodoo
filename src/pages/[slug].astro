---
import Layout from '@/layouts/Layout.astro'
import {getCollection, render} from 'astro:content'
import Mermaid from '@/components/Mermaid.astro'

export async function getStaticPaths(): Promise<Array<{ params: { slug: string }, props: { post: any } }>> {
    const blogEntries = await getCollection("blog");

    const posts = blogEntries
        .map(post => {
        const slug = post.id
            return {
            params: { slug },
            props: { post },
            }
    })
    return posts
}
const {post} = Astro.props;
const { title, date, tags} = post.data; 
const { Content } = await render(post);
---

<Layout title={title}>
	<div class='max-w-4xl mx-auto'>
		<article
			class='prose max-w-none prose-headings:text-base-content prose-p:text-base-content/80'
		>
			<!-- Header section -->
			<div class='mb-8 border-b pb-8'>
				<h1 class='text-4xl font-bold mb-4 text-base-content'>{title}</h1>
				<div class='flex flex-wrap items-center gap-4 text-base-content/70'>
					<!-- Date -->
					<time datetime={date} class='flex items-center'>
						<svg
							xmlns='http://www.w3.org/2000/svg'
							class='h-4 w-4 mr-2'
							fill='none'
							viewBox='0 0 24 24'
							stroke='currentColor'
						>
							<path
								stroke-linecap='round'
								stroke-linejoin='round'
								stroke-width='2'
								d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'
							></path>
						</svg>
						{
							new Date(date).toLocaleDateString('en-US', {
								year: 'numeric',
								month: 'long',
								day: 'numeric',
							})
						}
					</time>

					<!-- Tags -->
					{
						tags && (
							<div class='flex flex-wrap gap-2'>
								{tags.map(tag => (
									<span class='badge badge-accent badge-outline'>{tag}</span>
								))}
							</div>
						)
					}
				</div>
			</div>

			<!-- Post content -->
			<div
				class='prose mt-8 prose-h2:text-2xl prose-h2:font-bold prose-h2:mb-4
         prose-h3:text-xl prose-h3:font-semibold prose-h3:mb-3
         prose-p:mb-4 prose-p:leading-relaxed
         prose-strong:text-base-content prose-strong:font-bold
         prose-em:italic
         prose-a:text-accent prose-a:no-underline hover:prose-a:underline
         prose-code:text-accent prose-code:bg-base-200 prose-code:px-1 prose-code:py-0.5 prose-code:rounded
         prose-pre:bg-base-200 prose-pre:border prose-pre:border-base-300 prose-pre:rounded-lg prose-pre:p-4 prose-pre:overflow-x-auto
         prose-pre-code:bg-transparent prose-pre-code:text-base-content prose-pre-code:p-0 prose-pre-code:rounded-none
         prose-blockquote:border-l-4 prose-blockquote:border-accent prose-blockquote:pl-4 prose-blockquote:italic
         prose-ul:list-disc prose-ul:pl-6
         prose-ol:list-decimal prose-ol:pl-6
         prose-li:mb-2
         prose-img:rounded-lg prose-img:my-8'
        >
                <Content />
			</div>
			<Mermaid />
		</article>
	</div>
</Layout>

<script>
	// Remove Shiki's inline background styles that cause black background
	if (typeof window !== 'undefined') {
		function fixCodeBlockStyles() {
			// Fix pre elements
			const preElements = document.querySelectorAll('.prose pre');
			preElements.forEach((pre) => {
				// Remove any inline background styles
				if (pre.style.backgroundColor) {
					pre.style.backgroundColor = '';
				}
				if (pre.style.background) {
					pre.style.background = '';
				}
				// Ensure text color is readable
				if (pre.style.color === 'rgb(255, 255, 255)' || pre.style.color === '#ffffff' || pre.style.color === 'white') {
					pre.style.color = '';
				}
			});
			
			// Fix code elements
			const codeElements = document.querySelectorAll('.prose pre code');
			codeElements.forEach((code) => {
				// Remove background
				if (code.style.backgroundColor) {
					code.style.backgroundColor = '';
				}
				if (code.style.background) {
					code.style.background = '';
				}
				// Fix text color
				if (code.style.color === 'rgb(255, 255, 255)' || code.style.color === '#ffffff' || code.style.color === 'white') {
					code.style.color = '';
				}
			});
			
			// Fix all spans inside code blocks
			const spans = document.querySelectorAll('.prose pre code span');
			spans.forEach((span) => {
				// Remove background colors
				if (span.style.backgroundColor) {
					span.style.backgroundColor = '';
				}
				if (span.style.background) {
					span.style.background = '';
				}
				// Fix white text to use theme color
				const color = span.style.color;
				if (color === 'rgb(255, 255, 255)' || 
				    color === '#ffffff' ||
				    color === 'white' ||
				    color === 'rgb(255, 255, 255)' ||
				    (color && color.toLowerCase().includes('255, 255, 255'))) {
					span.style.color = '';
				}
			});
		}
		
		// Run on initial load
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', () => {
				setTimeout(fixCodeBlockStyles, 100);
				setTimeout(fixCodeBlockStyles, 500);
			});
		} else {
			setTimeout(fixCodeBlockStyles, 100);
			setTimeout(fixCodeBlockStyles, 500);
		}
		
		// CRITICAL: Also run after Astro view transitions
		document.addEventListener('astro:page-load', () => {
			setTimeout(fixCodeBlockStyles, 100);
			setTimeout(fixCodeBlockStyles, 500);
		});
	}
</script>

<style>
	/* Code block styling - ensure readable colors */
	.prose pre {
		background-color: hsl(var(--b2)) !important;
		border: 1px solid hsl(var(--bc) / 0.2) !important;
		border-radius: 0.5rem !important;
		padding: 1rem !important;
		margin: 1.5rem 0 !important;
		overflow-x: auto !important;
		font-size: 0.875rem !important;
		line-height: 1.75 !important;
		color: hsl(var(--bc)) !important;
	}
	
	.prose pre code {
		background-color: transparent !important;
		color: hsl(var(--bc)) !important;
		padding: 0 !important;
		border-radius: 0 !important;
		font-size: inherit !important;
		font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, "Liberation Mono", monospace !important;
		display: block !important;
		width: 100% !important;
	}
	
	/* Override Shiki's background colors - use theme colors instead */
	.prose pre code[class*="language-"],
	.prose pre code[style*="background"] {
		background: transparent !important;
	}
	
	/* Override Shiki token colors to be readable with theme */
	.prose pre code span[style*="color"] {
		/* Keep Shiki's syntax colors but ensure they're visible */
		display: inline !important;
		opacity: 1 !important;
	}
	
	/* Remove all background colors from syntax highlighting tokens */
	.prose pre code span[style*="background-color"],
	.prose pre code span[style*="background"] {
		background: transparent !important;
		background-color: transparent !important;
	}
	
	/* Remove weird highlighting artifacts */
	.prose pre code .highlight,
	.prose pre code mark {
		background: transparent !important;
		background-color: transparent !important;
		padding: 0 !important;
		margin: 0 !important;
	}
	
	/* Ensure line numbers if present are styled correctly */
	.prose pre code[data-line-numbers] {
		counter-reset: line;
	}
	
	.prose pre code[data-line-numbers] > span[data-line]::before {
		counter-increment: line;
		content: counter(line);
		display: inline-block;
		width: 1rem;
		margin-right: 1rem;
		text-align: right;
		color: hsl(var(--bc) / 0.5);
	}
	
	/* Inline code should remain styled differently */
	.prose :not(pre) > code {
		background-color: hsl(var(--b2)) !important;
		color: hsl(var(--a)) !important;
		padding: 0.125rem 0.375rem !important;
		border-radius: 0.25rem !important;
		font-size: 0.875em !important;
	}
	
	/* Ensure code blocks don't have weird spacing */
	.prose pre code br {
		display: block;
		content: "";
		margin: 0;
	}
	
	/* Completely override Shiki's background - force theme background */
	.prose pre[style*="background"],
	.prose pre[style*="background-color"] {
		background-color: hsl(var(--b2)) !important;
		background: hsl(var(--b2)) !important;
	}
	
	/* Force readable text color - override Shiki's white text on black */
	.prose pre code {
		color: hsl(var(--bc)) !important;
	}
	
	/* Override all Shiki token colors - use theme text color for readability */
	.prose pre code span[style*="color"] {
		color: hsl(var(--bc)) !important;
	}
	
	/* Ensure all text in code blocks uses theme colors */
	.prose pre,
	.prose pre code,
	.prose pre code span,
	.prose pre code * {
		color: hsl(var(--bc)) !important;
	}
	
	/* Remove any inline background styles from Shiki - force theme background */
	.prose pre[style*="background"],
	.prose pre[style*="background-color"],
	.prose pre code[style*="background"],
	.prose pre code[style*="background-color"] {
		background-color: hsl(var(--b2)) !important;
		background: hsl(var(--b2)) !important;
	}
</style>
